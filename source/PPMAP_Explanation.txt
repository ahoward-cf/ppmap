	PPMAP
	=====

	Ken Marsh
	Cardiff University
	Ken.Marsh@astro.cf.ac.uk

PURPOSE OF ALGORITHM: 
	Generate image cubes of differential column density as a function
	of (x,y) sky position and temperature, for diffuse dusty structures.

DETAILED DESCRIPTION:
	Please see Marsh et al. 2015, MNRAS 454, 4282

PRINCIPAL INPUTS:
	 (1) Set of observational images at various wavelengths 
	     (e.g. Herschel 70-500 microns)

	 (2) Point spread function at each wavelength

	 (3) Set of input parameter values. This includes a grid of 
	     temperatures, specified by the number of points and the range
	     of values. The grid will be generated by logarithmically
	     interpolating between the specified limits. The file also 
	     includes a list of the input FITS file names.

	 (4) Colour correction table (if necessary -- see below).

SOFTWARE DETAILS:
	Written in Fortran 90, but some of the subroutines called are in 
	Fortran 77.

	Incorporates parallel processing using OpenMP for some of the more
	cpu-intensive steps.

	Currently configured for the "Raven" cluster at Cardiff University
	and runs in a mode in which the computations are split between 
	16 separate nodes, each of which utilises 16 cores with OpenMP.

	There are two main steps involving two separate executables, 
	PREMAP and PPMAP, as follows:

	Step 1: PREMAP: The preprocessing step
	    - Purpose: parameter input, reformatting, and script generation. 
	    - Read observational images.
	    - Read PSFs.
	    - Read mapping parameters, which include the centre position 
	      of the field to be mapped, and the field dimensions.
	    - Generate scripts for running PPMAP in parallel processing
	      mode as outlined above.

	Step 2: PPMAP: The actual mapping.
	    - Construct each image cube by mapping a large number of small
	      fields (typically 40 x 40 spatial pixels) and then mosaicing
              them all together using the subroutine PPMOSAIC. The reason
	      for this is that the computation time goes basically as the
	      square of the number of spatial pixels, so overall computation
	      time is reduced by dividing into a large number of small fields
	      rather than doing a single large field.

INSTALLATION:
	These routines use the cfitsio library, available from:

	      http://heasarc.gsfc.nasa.gov/fitsio

	Included with that library is a set of Fortran 77 wrappers which are
	called by PREMAP and PPMAP. So the first step is to install the 
	library in order to generate the file:

	      libcfitsio.a

	Next, the two main programmes PREMAP and PPMAP need to be compiled.
	On our installation, this is accomplished using a pair of shell scripts
	(included with this package) by typing:

	      sh premap_compile

	      sh ppmap_compile

RUNNING PPMAP:
	The following items need to be in the local directory:
	
	(1) Executable files: premap, ppmap.
	(2) Input parameters file (e.g. testfield_premap.inp).
	(3) Subdirectory containing observed images for the field in question.
	    e.g. "testfield"
	(5) Subdirectory into which the output will go. It must have a name
            of the form <fieldname>_results, e.g. testfield_results
	(6) Set of PSF files (the PSFs for Herschel 70, 100, 160, 250, 350, 
	    & 500 microns are included with this package).

	In addition, if observational (as opposed to simulated) data are to 
	be run, a colour correction table is normally necessary. Two examples
	of colour correction tables are included with this package, namely:
	colourcorr_beta2.txt and colourcorr_3pacs_beta2.txt. They are 
	appropriate for 5 or 6-band Herschel data, respectively, based on 
	an assumed opacity law index, beta, of 2.0. If colour corrections 
	are to be applied, an extra line needs to be added to the *_premap.inp 
	file. For example:

	    colourcorr_beta2.txt      <ccfile>  ; colour correction table
	
	The sequence of operations necessary to run PPMAP can then be 
	carried out by running a single shell script (see example below).

OUTPUTS:
	(1) Image cube of differential column density.
	(2) Associated uncertainty (another image cube).
	(3) Integrated column density map.
	(4) Mean line-of-sight temperature map (density-weighted).
	(5) Maps of other temperature moments: variance, skewness, kurtosis.
	(6) Text file containing histogram of reduced chi squared values.

EXAMPLE:
	To run ppmap on the testfield (or a subregion within that field), the 
	Herschel input images are placed in a subdirectory called "testfield". 
	The input parameters are specified in a file "testfield_premap.inp", 
	whose contents (for example) are:

----------------------------testfield_premap.inp----------------------------
Parameter value            Name of variable          Description

159.4507                         <gloncent> ; gal. long. (or RA) at centre [deg]
-19.8196                         <glatcent> ; gal. lat. (or Dec) at centre [deg]
0.25 0.25                        <fieldsize>; field of view dimensions [deg]
4.                               <pixel>    ; output sampling interval [arcsec]
10.                              <dilution> ; a priori dilution 
10000                            <maxiterat>; max no. of integration steps
100.                             <distance> ; [pc]
0.1                              <kappa300> ; reference opacity [cm^2/g]
2.                               <beta>     ; opacity law index
40                               <ncells>   ; nominal size of subfield
20                               <noverlap> ; size of subfield overlap
12                               <Nt>       ; number of temperatures
7. 25.                           <temprange>; range of temperatures [K]
6                                <nbands>   ; number of bands
70. 100., 160. 250. 350. 500.    <wavelen>  ; wavelengths [microns]
10.  12.   76. 123. 103.  53.    <sigobs>   ; measurement noise values [MJy/sr]
                                 <obsimages>; list of FITS files follows:
testimage_070.fits
testimage_100.fits
testimage_160.fits
testimage_250.fits
testimage_350.fits
testimage_500.fits
----------------------------------------------------------------------------

	Based on the above parameters, PPMAP will use a temperature
	grid consisting of 12 values logarithmically spaced between
	7 K and 25 K, i.e.

 Tgrid [K]:   7.000000       8.063525       9.288633       10.69987    
   12.32553       14.19817       16.35533       18.84023       21.70267    
   25.00000    


        PPMAP could then be run by typing:

	      sh run_testfield_all

	where the script "run_testfield_all" consists of:
	
------------------------------run_testfield_all   --------------------------
module purge
module load intel
cp psfs/* .
./premap testfield
mkdir /scratch/<username>/testfield
cp testfield/* /scratch/<username>/testfield
mkdir /scratch/<username>/testfield_results
rm /scratch/<username>/testfield_results/*
cp testfield_ppmap.inp /scratch/<username>
cp *testfield*fits /scratch/<username>
cp testfield/* /scratch/<username>/testfield
cp psf_*fits /scratch/<username>
sh run_testfield
----------------------------------------------------------------------------

	in which all instances of <username> should be replaced by the
	actual user name.

	This will then set everything in motion. PREMAP will generate
	its own set of scripts for running PPMAP, and these will get run
	automatically. It will write a large number of subfield files (in FITS 
	format) into /scratch/<username>/testfield_results, with file names 
	like:  testfield_00001_rho.fits. These will be generated in parallel 
	by 16 separate processes. PPMAP will then call subroutine PPMOSAIC to 
	do the mosaicing -- it will keep checking until all necessary subfield 
	files are in place. The results will appear in subdirectory 
	/scratch/<username>/testfield_results and will consist of the following 
	files:

	      testfield_tdenscube.fits	image cube of differential col density
	      testfield_sigtdenscube.fits   associated uncertainty
	      testfield_cdens.fits          2D map of integrated column density
	      testfield_temp.fits           2D map of mean line-of-sight temp
	      testfield_tvar.fits           2D map of temperature variance
	      testfield_tskew.fits          2D map of temperature skewness
	      testfield_tkurt.fits          2D map of temperature kurtosis
	      testfield_rchisq.txt          reduced chi squared histogram values

----------------------------------------------------------------------------

	The first two of those output files are included with this package
	to provide a check that everything worked as it should.


NOTES:

1.	The "a priori dilution" parameter, denoted "eta" in Marsh et al
	(2015): This parameter controls the degree to which PPMAP tries to
	fit the data with the fewest number of components. A large value
	allows a large number of components to be used, but with a penalty
	of reduced resolution, both spatially and in temperature. With too 
	small a value the algorithm would not be able to fit the data
	completely. In practice, the value 0.3 suggested above (in
	testfield_premap.inp) should cover most cases.

2.	Sometimes the message "Solution divergent" appears on the screen.
	It does not usually indicate a problem -- it basically means that 
	model errors have become comparable with measurement errors and 
	therefore further iteration is not warranted, i.e., the fit is as good 
	as it can get, given the model.

